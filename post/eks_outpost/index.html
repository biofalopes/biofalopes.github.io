

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Deploying a Local EKS Cluster on AWS Outposts - Hi, Iâ€™m Fabio</title>

  <meta name="description" content="Using terraform to deploy the resources and the parameters required for the local Control Plane">
  <meta name="author" content="Fabio M. Lopes"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Fabio M. Lopes",
    
    "url": "https:\/\/fabiolopes.page\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/fabiolopes.page\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/fabiolopes.page\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/fabiolopes.page\/post\/eks_outpost\/",
          "name": "Deploying a local eks cluster on aws outposts"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Fabio M. Lopes"
  },
  "headline": "Deploying a Local EKS Cluster on AWS Outposts",
  "description" : "The Terraform code provisions an EKS cluster on an AWS Outpost, with the control plane running locally on the Outpost. This differs significantly from deploying an EKS cluster in a standard AWS region, primarily in how worker nodes are managed.\nThe Amazon EKS update history demonstrates the platform\u0026rsquo;s continuous evolution, focusing on enhanced security, scalability, and integration with other AWS services. Since its initial release in June 2018, there\u0026rsquo;s been a significant increase in available features and functionalities, including support for newer Kubernetes versions, expansion to new AWS regions, and the introduction of new deployment options like Fargate and local clusters on AWS Outposts, which is the focus of this work. The introduction of features like managed node groups significantly simplified infrastructure management, automating tasks such as provisioning and lifecycle management of nodes. The availability of EKS-optimized AMIs, including options with GPU support and the Bottlerocket operating system, offers greater flexibility and performance for diverse workloads. Furthermore, integration with services like Amazon EBS, EFS, and FSx for Lustre, via CSI drivers, expanded storage options for the clusters. However, for a local Amazon EKS cluster on AWS Outposts, these resources are significantly more limited; managed node groups are unavailable.\n",
  "inLanguage" : "en",
  "wordCount":  2067 ,
  "datePublished" : "2024-12-06T00:00:00\u002b00:00",
  "dateModified" : "2024-12-06T00:00:00\u002b00:00",
  "image" : "https:\/\/fabiolopes.page\/img\/logo.jpg",
  "keywords" : [ "aws, terraform, kubernetes" ],
  "mainEntityOfPage" : "https:\/\/fabiolopes.page\/post\/eks_outpost\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/fabiolopes.page\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/fabiolopes.page\/img\/logo.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Deploying a Local EKS Cluster on AWS Outposts" />
<meta property="og:description" content="Using terraform to deploy the resources and the parameters required for the local Control Plane">
<meta property="og:image" content="https://fabiolopes.page/img/logo.jpg" />
<meta property="og:url" content="https://fabiolopes.page/post/eks_outpost/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Fabio M. Lopes" />

  <meta name="twitter:title" content="Deploying a Local EKS Cluster on AWS Outposts" />
  <meta name="twitter:description" content="Using terraform to deploy the resources and the parameters required for the local Control Plane">
  <meta name="twitter:image" content="https://fabiolopes.page/img/logo.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://fabiolopes.page/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.139.3">
  <link rel="alternate" href="https://fabiolopes.page/index.xml" type="application/rss+xml" title="Fabio M. Lopes"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://fabiolopes.page/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://fabiolopes.page/css/highlight.min.css" /><link rel="stylesheet" href="https://fabiolopes.page/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://fabiolopes.page/">Fabio M. Lopes</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Fabio M. Lopes" href="https://fabiolopes.page/">
            <img class="avatar-img" src="https://fabiolopes.page/img/logo.jpg" alt="Fabio M. Lopes" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  
    <div id="header-big-imgs" data-num-img=1
      
         
          data-img-src-1="https://fabiolopes.page/img/aws/outpost.jpg"
         
         data-img-desc-1="outpost"
      ></div>
  

  <header class="header-section has-img">
    
      
      <div class="intro-header big-img" style="background-image: url('img/aws/outpost.jpg');">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>Deploying a Local EKS Cluster on AWS Outposts</h1>
                  
                    
                      <h2 class="post-subheading">Using terraform to deploy the resources and the parameters required for the local Control Plane</h2>
                    
                  
                  
                    <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on December 6, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;10&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2067&nbsp;words
  
  
    
      
        &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Fabio M. Lopes
      
    
  
  
</span>


                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;">outpost</span>
      </div>
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Deploying a Local EKS Cluster on AWS Outposts</h1>
              
              
              
                
                  <h2 class="post-subheading">Using terraform to deploy the resources and the parameters required for the local Control Plane</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on December 6, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;10&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2067&nbsp;words
  
  
    
      
        &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Fabio M. Lopes
      
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>The Terraform code provisions an EKS cluster on an AWS Outpost, with the control plane running locally on the Outpost. This differs significantly from deploying an EKS cluster in a standard AWS region, primarily in how worker nodes are managed.</p>
<p>The Amazon EKS update history demonstrates the platform&rsquo;s continuous evolution, focusing on enhanced security, scalability, and integration with other AWS services. Since its initial release in June 2018, there&rsquo;s been a significant increase in available features and functionalities, including support for newer Kubernetes versions, expansion to new AWS regions, and the introduction of new deployment options like Fargate and local clusters on AWS Outposts, which is the focus of this work. The introduction of features like managed node groups significantly simplified infrastructure management, automating tasks such as provisioning and lifecycle management of nodes. The availability of EKS-optimized AMIs, including options with GPU support and the Bottlerocket operating system, offers greater flexibility and performance for diverse workloads. Furthermore, integration with services like Amazon EBS, EFS, and FSx for Lustre, via CSI drivers, expanded storage options for the clusters. However, for a local Amazon EKS cluster on AWS Outposts, these resources are significantly more limited; managed node groups are unavailable.</p>
<p>We also observed that the Control Plane AMIs are automatically provisioned with Bottlerocket, where we only specify the major Kubernetes release, and the latest minor version is selected. The challenge lies in provisioning worker nodes, which requires selecting an EKS-optimized AMI from the available options in the AWS catalog; only versions with Amazon Linux 2023 are found. While not inherently problematic, ensuring both control plane and worker nodes use the same Kubernetes version proved difficult, requiring testing three or four AMIs to find the closest match.</p>
<p>Finally, we lacked the usual EKS add-ons, which in this scenario require manual provisioning, such as CSI, CNI, Cluster Load Balancer Controller, Metrics Server, or Kube-prometheus-stack, to name a few but not necessarily all.</p>
<p>Important Considerations for Provisioning EKS on Outposts:
AMI: Ensure you use an Amazon Machine Image (AMI) compatible with your Outpost and the chosen Kubernetes version. Review the use of data.aws_ami; manually specifying the AMI is strongly recommended to guarantee compatibility. Not all region-available versions are available on the Outpost; there&rsquo;s usually a two-version lag.</p>
<p>Security: Carefully review security rules in the Security Groups. Limit access only to necessary ports and IPs.</p>
<p>Scalability: Adjust min_size, desired_capacity, and max_size values in the ASG to meet scalability needs. Arbitrary values were configured only to enable code construction and simplified usage tests for the proof of concept.</p>
<p>High Availability: For high availability, consider creating the cluster across multiple subnets associated with the Outpost. Due to limitations in the proof-of-concept environment, only available subnets were used.</p>
<p>Monitoring: Implement a monitoring system for the EKS cluster and worker nodes. CloudWatch is the most straightforward option, but due to associated costs and integration with pre-existing tools, other options might be more suitable, such as a Grafana stack (Loki, Mimir, Grafana, Tempo, Prometheus).</p>
<p>The following is a commented version of the code, highlighting key configurations and differences compared to an EKS cluster in a region:</p>
<h3 id="part-1-eks-control-plane">Part 1: EKS Control Plane</h3>
<p>This section describes the infrastructure required for the EKS control plane on the Outpost. Note that the control plane configuration is similar to a region cluster, but with the crucial addition of the outpost_config.</p>
<h4 id="providerstf">providers.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">provider &#34;aws&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">region  = local.region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="terraformtf">terraform.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">terraform {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">backend &#34;s3&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bucket = &#34;outposts-bucket&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">key    = &#34;eks-local-terraform-state&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">region = &#34;us-east-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="variablestf">variables.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">variable &#34;eks_cluster_name&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;eks_local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;eks_cluster_version&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;1.30&#34;</span><span class="w"> </span><span class="c"># available versions differ between regional and local cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;eks_vpc&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;vpc-id0000&#34;</span><span class="w"> </span><span class="c"># replace with your vpc id </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;eks_subnet&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;subnet-id0000&#34;</span><span class="w"> </span><span class="c"># replace with your subnet id </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;bastion_subnet&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;subnet-id0000&#34;</span><span class="w"> </span><span class="c"># replace with your subnet id  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;control_plane_instance_type&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;m5.large&#34;</span><span class="w"> </span><span class="c"># Choose an instance type that is available in your outpost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;tags&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type        = map(any)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;(Optional) Tags to apply to all tag-able resources.&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default     = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">terraform = &#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="outputstf">outputs.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">output &#34;eks_cluster_endpoint&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;EKS Cluster Endpoint&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">value       = aws_eks_cluster.eks_cluster.endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">output &#34;eks_cluster_ca&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">value = base64decode(aws_eks_cluster.eks_cluster.certificate_authority[0].data)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">output &#34;eks_cluster_arn&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;EKS Cluster ARN&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">value       = aws_eks_cluster.eks_cluster.arn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">output &#34;kubeconfig&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">value = &lt;&lt;EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">cluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.endpoint}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">certificate-authority-data</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.certificate_authority.0.data}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">contexts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">context</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">current-context</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">${aws_eks_cluster.eks_cluster.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;client.authentication.k8s.io/v1beta1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;aws&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;eks&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;get-token&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;--cluster-name&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;${aws_eks_cluster.eks_cluster.name}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;--region&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;${local.region}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Kubeconfig for the EKS Cluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">sensitive   = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="maintf">main.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">locals {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">region    = &#34;us-east-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_outposts_outpost&#34; &#34;my_outpost&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = &#34;op-06d4362ae79bc4247&#34; </span><span class="w"> </span><span class="c"># Outpost id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_vpc&#34; &#34;vpc_eks&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = var.eks_vpc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_subnet&#34; &#34;vpc_eks&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = var.eks_subnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_subnet&#34; &#34;vpc_bastion&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = var.bastion_subnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Role for the Control Plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role&#34; &#34;eks_cluster_role&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name = &#34;eks-cluster-role&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">assume_role_policy = jsonencode({</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">Version = &#34;2012-10-17&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">Statement = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Effect = &#34;Allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Principal = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="l">Service = &#34;eks.amazonaws.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Action = &#34;sts:AssumeRole&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Effect = &#34;Allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Principal = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="l">Service = &#34;ec2.amazonaws.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Action = &#34;sts:AssumeRole&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="l">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Control Plane Policies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;eks_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEKSClusterPolicy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_cluster_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;eks_LocalOutpost_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEKSLocalOutpostClusterPolicy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_cluster_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;eks_cni_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_cluster_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;eks_VPCResourceController_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEKSVPCResourceController&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_cluster_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;eks_ssm_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_cluster_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;eks_cloudwatch_logs&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/CloudWatchLogsFullAccess&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_cluster_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># CloudWatch Log Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_cloudwatch_log_group&#34; &#34;eks_log_group&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name              = &#34;/aws/eks/${var.eks_cluster_name}/cluster-logs&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">retention_in_days = 7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Security group for EKS control plane in Outposts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_security_group&#34; &#34;control_plane_sg&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name        = &#34;${var.eks_cluster_name}-control-plane-sg&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vpc_id      = data.aws_vpc.vpc_eks.id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Security group for EKS control plane in Outposts&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">ingress {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">description = &#34;Allow inbound HTTPS for EKS API server&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">from_port   = 443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">to_port     = 443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">protocol    = &#34;tcp&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cidr_blocks = [data.aws_subnet.subnet_eks.cidr_block, data.aws_subnet.subnet_bastion.cidr_block]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">egress {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">description = &#34;Allow all outbound traffic&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">from_port   = 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">to_port     = 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">protocol    = &#34;-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cidr_blocks = [&#34;0.0.0.0/0&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># EKS Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_eks_cluster&#34; &#34;eks_cluster&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name    = var.eks_cluster_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">version = var.eks_cluster_version</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role_arn = aws_iam_role.eks_cluster_role.arn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">enabled_cluster_log_types = [&#34;audit&#34;]</span><span class="w"> </span><span class="c"># choose accordingly</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vpc_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">endpoint_private_access = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">endpoint_public_access  = false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">security_group_ids      = [aws_security_group.control_plane_sg.id]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">subnet_ids              = [data.aws_subnet.subnet_eks.id]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">outpost_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">outpost_arns                = [data.aws_outposts_outpost.my_outpost.arn]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">control_plane_instance_type = var.control_plane_instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">access_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">authentication_mode                         = &#34;CONFIG_MAP&#34; </span><span class="w"> </span><span class="c"># Local Outpost clusters only support config_map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bootstrap_cluster_creator_admin_permissions = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">upgrade_policy {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">support_type = &#34;STANDARD&#34;</span><span class="w"> </span><span class="c"># you can set it to anything but it will end up as EXTENDED.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tags = var.tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">depends_on = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">aws_iam_role_policy_attachment.eks_policy,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">aws_iam_role_policy_attachment.eks_cni_policy,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">aws_iam_role_policy_attachment.eks_VPCResourceController_policy,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">aws_iam_role_policy_attachment.eks_LocalOutpost_policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># writes a kubeconfig file locally</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;null_resource&#34; &#34;write_kubeconfig&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">provisioner &#34;local-exec&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">command = &lt;&lt;EOT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">aws eks update-kubeconfig --name ${aws_eks_cluster.eks_cluster.name} --region ${local.region}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">EOT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>After provisioning the Control Plane, it&rsquo;s necessary to configure the aws-auth ConfigMap with the role that will be associated with the worker nodes. In this example it was also associated the instance profile associated with a bastion host, used to access the EKS cluster via kubectl:</p>
<h4 id="config-map-aws-auth">Config Map aws-auth:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aws-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mapRoles</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    - rolearn: arn:aws:iam::597088017848:role/eks-nodegroup-role
</span></span></span><span class="line"><span class="cl"><span class="sd">      username: system:node:{{EC2PrivateDNSName}}
</span></span></span><span class="line"><span class="cl"><span class="sd">      groups:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - system:bootstrappers
</span></span></span><span class="line"><span class="cl"><span class="sd">        - system:nodes
</span></span></span><span class="line"><span class="cl"><span class="sd">    - rolearn: arn:aws:iam::597088017848:role/myrole-ec2-ssm-enhanced
</span></span></span><span class="line"><span class="cl"><span class="sd">      username: bastion
</span></span></span><span class="line"><span class="cl"><span class="sd">      groups:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - system:masters</span><span class="w">    
</span></span></span></code></pre></div><h3 id="part-2-eks-nodes">Part 2: EKS Nodes</h3>
<p>When provisioning EKS on Outpost as a Local Cluster, it is not possible to use Node Groups. The solution is to create a Launch Template, associate it with an Autoscaling Group and use a <em>user-data</em> script to configure the nodes in the EKS cluster.</p>
<h4 id="providerstf-1">providers.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">provider &#34;aws&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">region  = local.region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="terraformtf-1">terraform.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">terraform {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">backend &#34;s3&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bucket = &#34;outposts-bucket&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">key    = &#34;eks-local-terraform-state&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">region = &#34;us-east-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="variablestf-1">variables.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">variable &#34;eks_cluster_name&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;eks_local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;eks_cluster_version&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;1.30&#34;</span><span class="w"> </span><span class="c"># available versions differ between regional and local cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;eks_vpc&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;vpc-id0000&#34;</span><span class="w"> </span><span class="c"># replace with your vpc id </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;eks_subnet&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;subnet-id0000&#34;</span><span class="w"> </span><span class="c"># replace with your subnet id </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;bastion_subnet&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;subnet-id0000&#34;</span><span class="w"> </span><span class="c"># replace with your subnet id  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;control_plane_instance_type&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;m5.large&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;control_plane_instance_type&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;m5.large&#34;</span><span class="w"> </span><span class="c"># Choose an instance type that is available in your outpost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;node_group_min_size&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;node_group_desired_size&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;node_group_max_size&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type    = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;node_group_name&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type        = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;(Optional) The name to be used for the self-managed node group. By default, the module will generate a unique name.&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default     = &#34;node_group&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;tags&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type        = map(any)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;(Optional) Tags to apply to all tag-able resources.&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">default     = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">terraform = &#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><h4 id="maintf-1">main.tf:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">locals {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">region    = &#34;us-east-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_outposts_outpost&#34; &#34;my_outpost&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = &#34;op-id0000&#34;</span><span class="w"> </span><span class="c"># your Outpost ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_vpc&#34; &#34;vpc_eks&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = var.eks_vpc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_subnet&#34; &#34;subnet_eks&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = var.eks_subnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_subnet&#34; &#34;subnet_bastion&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">id = var.bastion_subnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_eks_cluster&#34; &#34;eks_cluster&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name = var.eks_cluster_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_security_group&#34; &#34;control_plane_sg&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name = &#34;${var.eks_cluster_name}-control-plane-sg&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Instance Type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_ec2_instance_type&#34; &#34;selected_instance&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">instance_type = var.node_group_instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># AMI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;aws_ami&#34; &#34;eks_ami&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">owners      = [&#34;amazon&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">most_recent = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">filter {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">name   = &#34;name&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">values = [&#34;amazon-eks-node-${data.aws_eks_cluster.eks_cluster.version}*&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">filter {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">name   = &#34;architecture&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">values = data.aws_ec2_instance_type.selected_instance.supported_architectures</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">filter {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">name   = &#34;virtualization-type&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">values = data.aws_ec2_instance_type.selected_instance.supported_virtualization_types</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">filter {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">name   = &#34;root-device-type&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">values = data.aws_ec2_instance_type.selected_instance.supported_root_device_types</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># User Data for the Worker Nodes - Script to join the nodes to the EKS cluster. `--enable-local-outpost true` is crucial.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">data &#34;template_file&#34; &#34;user_data&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">template = &lt;&lt;-EOT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c">#!/bin/bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">set -o xtrace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">/etc/eks/bootstrap.sh ${var.eks_cluster_name} \</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>--<span class="l">enable-local-outpost true \</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>--<span class="l">cluster-id &#39;${data.aws_eks_cluster.eks_cluster.id}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="l">EOT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Worker Nodes Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role&#34; &#34;eks_nodegroup_role&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name = &#34;eks-nodegroup-role&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">assume_role_policy = jsonencode({</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">Version = &#34;2012-10-17&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">Statement = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Effect = &#34;Allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Principal = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="l">Service = &#34;eks.amazonaws.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Action = &#34;sts:AssumeRole&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Effect = &#34;Allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Principal = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="l">Service = &#34;ec2.amazonaws.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">Action = &#34;sts:AssumeRole&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="l">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Node Policies - These policies ensure that nodes have correct access to the necessary resources.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;nodegroup_cni_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_nodegroup_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;nodegroup_worker_node_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_nodegroup_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;nodegroup_ecr_read_only_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_nodegroup_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_role_policy_attachment&#34; &#34;nodegroup_ssm_policy&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">policy_arn = &#34;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role       = aws_iam_role.eks_nodegroup_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># IAM Instance Profile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_iam_instance_profile&#34; &#34;eks_node_instance_profile&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name = &#34;${var.eks_cluster_name}-node-instance-profile&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">role = aws_iam_role.eks_nodegroup_role.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Worker Nodes Security group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_security_group&#34; &#34;nodes_sg&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name        = &#34;${var.eks_cluster_name}-nodes-sg&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vpc_id      = data.aws_vpc.vpc_eks.id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Security group for EKS nodes in Outposts&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">ingress {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">description = &#34;Allow all node-to-node communication&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">from_port   = 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">to_port     = 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">protocol    = &#34;-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">self        = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">ingress {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">description     = &#34;Allow nodes to communicate with EKS control plane&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">from_port       = 443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">to_port         = 443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">protocol        = &#34;tcp&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">security_groups = [data.aws_security_group.control_plane_sg.id]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">egress {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">description = &#34;Allow all outbound traffic&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">from_port   = 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">to_port     = 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">protocol    = &#34;-1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cidr_blocks = [&#34;0.0.0.0/0&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Launch Template for the Worker Nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_launch_template&#34; &#34;outposts_node_template&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name_prefix   = &#34;${var.eks_cluster_name}-node-template-&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># image_id      = data.aws_ami.eks_ami.id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">image_id      =  &#34;ami-023745e977279d33c&#34;</span><span class="w"> </span><span class="c"># Either use the filters set previously or pick manually an ami from the catalog to ensure version matching with the control plane nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">instance_type = var.node_group_instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">user_data     = base64encode(data.template_file.user_data.rendered)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vpc_security_group_ids = [aws_security_group.nodes_sg.id]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">key_name               = &#34;my-precious-key&#34;</span><span class="w"> </span><span class="c"># SSH key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">iam_instance_profile {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">name = aws_iam_instance_profile.eks_node_instance_profile.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ASG for Worker Nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;aws_autoscaling_group&#34; &#34;outposts_asg&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name                = &#34;${var.eks_cluster_name}-asg&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">desired_capacity    = 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">max_size            = 4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">min_size            = 1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vpc_zone_identifier = [data.aws_subnet.subnet_eks.id]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">launch_template {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">id      = aws_launch_template.outposts_node_template.id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">version = &#34;$Latest&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">health_check_type         = &#34;EC2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">health_check_grace_period = 300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">force_delete              = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tag {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">key                 = &#34;Name&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">value               = &#34;${var.eks_cluster_name}-${var.node_group_name}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">propagate_at_launch = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tag {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">key                 = &#34;kubernetes.io/cluster/${var.eks_cluster_name}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">value               = &#34;owned&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">propagate_at_launch = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>After a couple of minutes, the worker nodes will get registered in the kubernetes cluster. The master nodes remain as NotReady due to the absence of the CNI.</p>


        
          <div class="blog-tags">
            
              
              <a href="https://fabiolopes.page/tags/aws/">aws</a>&nbsp;
            
              
              <a href="https://fabiolopes.page/tags/terraform/">terraform</a>&nbsp;
            
              
              <a href="https://fabiolopes.page/tags/kubernetes/">kubernetes</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2ffabiolopes.page%2fpost%2feks_outpost%2f&amp;text=Deploying%20a%20Local%20EKS%20Cluster%20on%20AWS%20Outposts&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ffabiolopes.page%2fpost%2feks_outpost%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2ffabiolopes.page%2fpost%2feks_outpost%2f&amp;title=Deploying%20a%20Local%20EKS%20Cluster%20on%20AWS%20Outposts" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2ffabiolopes.page%2fpost%2feks_outpost%2f&amp;title=Deploying%20a%20Local%20EKS%20Cluster%20on%20AWS%20Outposts" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2ffabiolopes.page%2fpost%2feks_outpost%2f&amp;title=Deploying%20a%20Local%20EKS%20Cluster%20on%20AWS%20Outposts" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2ffabiolopes.page%2fpost%2feks_outpost%2f&amp;description=Deploying%20a%20Local%20EKS%20Cluster%20on%20AWS%20Outposts" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/post/terraform-study-guide/">HashiCorp Certified: Terraform Associate Exam</a></li>
                
                    <li><a href="/post/terraform-2/">Managing AWS Autoscaling Groups and Load Balancers using Terraform</a></li>
                
                    <li><a href="/post/terraform-1/">Basic Dev Environment on AWS using Terraform</a></li>
                
                    <li><a href="/post/rook/">Using Rook to leverage Ceph storage on a Kubernetes cluster</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://fabiolopes.page/post/terraform-study-guide/" data-toggle="tooltip" data-placement="top" title="HashiCorp Certified: Terraform Associate Exam">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      
      
      
      
      
          
          <div class="disqus-comments">                  
            <button id="show-comments" class="btn btn-default" type="button">Show <span class="disqus-comment-count" data-disqus-url="https://fabiolopes.page/post/eks_outpost">comments</span></button>
            <div id="disqus_thread"></div>

            <script type="text/javascript">
              var disqus_config = function () {
              this.page.url = 'https:\/\/fabiolopes.page\/post\/eks_outpost';
            };

          </script>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:fabioctba01@gmail.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/biofalopes" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/fabiomlopes" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://fabiolopes.page">Fabio M. Lopes</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://fabiolopes.page/">Fabio M. Lopes</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.139.3</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://fabiolopes.page/js/main.js"></script>
<script src="https://fabiolopes.page/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://fabiolopes.page/js/load-photoswipe.js"></script>









<script type="text/javascript">
$(function(){
  $('#show-comments').on('click', function(){
    var disqus_shortname = 'fabiomlopes';
      
    (function() {
      var disqus = document.createElement('script'); 
      disqus.type = 'text/javascript'; 
      disqus.async = true;
      disqus.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqus);
    })();
      
    $(this).hide(); 
    });
  });
      
</script>
<script id="dsq-count-scr" src="//fabiomlopes.disqus.com/count.js" async></script>




    
  </body>
</html>

